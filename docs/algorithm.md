# 差動駆動ロボットによる2Dターゲット探索シミュレーション仕様書

## 1. 概要

本システムは、ブラウザベースの2Dシミュレーション環境において、差動駆動型ロボットがフィールド内に設置された複数のターゲットを自律的に探索・接近するアルゴリズムを実行する。探索の初期アルゴリズムとして、単純かつ確実性の高い「外周走行 → ジグザグ走査法」を採用し、拡張としてフロンティア探索アルゴリズムへの対応も視野に入れる。

---

## 2. フィールド仕様

- **サイズ**: 有効エリア 80cm × 160cm（1cm解像度）、全体サイズ（外周ライン含む）90cm × 170cm
- **ターゲット**: 半径3cm × 12個、40cm間隔、フィールド境界上に配置
- **外周**: 幅5cmの黒ライン（壁の代用）、フォトセンサで検知可能
- **座標系**: 原点左上。X軸: 50–1650mm、Y軸: 50–850mm（フィールド有効エリア）

---

## 3. ロボット仕様

- **サイズ**: 30cm × 30cm × 30cm
- **移動方式**: 差動駆動（左右独立二輪）
- **最大速度**: 20cm/s、最大角速度: 90°/s
- **センサ**:
  - 距離センサ：前方25cm位置、-90°～90°回転可能、2cm～4m測定
  - フォトセンサ：ロボット前方左右、白黒検知
- **初期位置**: フィールド中央、縦向き

---

## 4. 制御API

- `setMotorSpeeds(left, right)`: 左右モータ速度制御（単位: cm/s）
- `setServo(angle)`: 距離センサの首振り（角度: -90～90°）
- `getDistance()`: 距離センサ値（cm）
- `getL_Photo()` / `getR_Photo()`: フォトセンサ白黒判定（bool）
- `delay(ms)`, `millis()`: タイマ制御用
- `found()` -> bool: ターゲットを発見したかどうかを返す

---

## 5. 探索アルゴリズム（初期実装）

### 5.1 ステートマシン構成

| 状態名 | 機能 |
|--------|------|
| START | 初期化、センサ初期設定 |
| PERIM | 外周ラインに沿ってフィールド一周、ターゲットの予備スキャン |
| SERP  | 40cm間隔の縦ジグザグ探索（ターゲット全網羅） |
| APPROACH | 距離センサ検知時、ターゲットに接近 |
| ESCAPE | 黒ライン・外周検知時の回避処理 |
| END | 探索終了処理（スコア集計・停止） |

### 5.2 到達条件

- 距離センサ ≤ 13cm かつ 片方以上のフォトセンサが黒検出 → ターゲット発見

### 5.3 スコアリング

- 新規ターゲット発見: +10点
- 再訪（別ルート）: +2点
- 連続再訪（同一ターゲット）: 0点

---

## 6. 安全システム

- **衝突判定**: ロボットが黒ライン上に乗った場合
- **落下判定**: ロボットがフィールド外へ出た場合
- **緊急停止**: 衝突・落下検出時は即座に制御停止

---

## 7. 拡張性: フロンティア探索の導入に向けて

### 7.1 フロンティア探索概要

フロンティア探索は、未知領域と既知領域の境界（フロンティア）を検出し、次に観測すべき領域を動的に選択する探索戦略。従来のパターン探索より柔軟かつ効率的にターゲットを探索できる。

### 7.2 フロンティア探索導入のための追加仕様

| 要素 | 内容 |
|------|------|
| マップ管理 | 2D Occupancy Grid: 0=未観測、1=空き、2=障害物 |
| フロンティア検出 | 空き領域の周囲に未知セルが存在するセル群を検出 |
| 経路計画 | A*などの簡易経路計画アルゴリズムで最短フロンティアへ移動 |
| 観測拡張 | 距離センサの扇形スキャンで点群マッピングを実施 |

---

## 8. 想定される運用フロー

1. システム初期化（START）
2. フィールド外周を巡回（PERIM）
3. フィールド内探索（SERP）
4. 距離センサによるターゲット接近（APPROACH）
5. ライン検知による回避（ESCAPE）
6. すべてのターゲットを訪問後停止（END）

---

## 9. 最適化探索戦略（固定環境対応）

### 9.1 固定環境の特性を活用した最適化

**固定環境の前提条件**:
- フィールドサイズ: 80cm × 160cm（完全固定）
- ターゲット位置: 12個、40cm間隔、境界線上（完全固定・既知）
- 初期位置: フィールド中央（850mm, 450mm）
- 環境は毎回同一で変化しない

### 9.2 最適化探索アルゴリズム

#### A. 直接アプローチ戦略（Direct Target Approach）
距離センサーによる動的スキャン＋フィードバック制御を組み合わせた探索戦略

**ステートマシン構成**:
1. **FIRST**: 初期回転（-90°）でスタート方向を調整
2. **SEARCH**: サーボスキャン（-90°～90°）でターゲット検出、最短距離ターゲットを選択
3. **CALIBRATED_APPROACH**: 3方向フィードバックスキャン（-15°, 0°, 15°）で方向修正しながら接近
4. **FOUND**: ターゲット発見時の処理（2秒停止）
5. **STEP_FORWARD**: 発見後の位置調整（後退→回転→前進）
6. **AVOID_FALL**: 黒ライン検知時の回避処理
7. **404**: タイムアウト時の復帰処理（前進→回転→再探索）

**実装特徴**:
- **動的ターゲット検出**: 距離センサーで実際のターゲット位置をリアルタイム検出
- **フィードバック制御**: 接近時に3方向スキャンで軌道修正
- **最大接近距離制限**: 2m超えると自動的に再探索
- **ターゲット選択戦略**: nearest（最短距離）、leftmost、rightmost、center_closest から選択可能
- **非同期処理**: モーター制御（200Hz）、センサー読み取り（50Hz）、フォトセンサー監視（50Hz）

**主要パラメータ**:
```javascript
{
  // スキャンパラメータ
  search_angle_L: -90,           // スキャン開始角度
  search_angle_R: 90,            // スキャン終了角度  
  search_angle_step: 4,          // スキャンステップ角度
  search_timeout: 15000,         // スキャンタイムアウト (ms)
  
  // 接近制御パラメータ
  approach_speed: 150,           // 基本接近速度
  distance_threshold: 2,         // ターゲット発見距離閾値 (cm)
  max_approach_distance: 2000,   // 最大接近距離 (mm)
  
  // フィードバック制御パラメータ
  feedback_scan_angles: [-15, 0, 15],    // フィードバック用スキャン角度
  direction_correction_gain: 2.0,        // 方向修正ゲイン
  min_approach_speed: 80,                // 最小接近速度
  max_approach_speed: 200                // 最大接近速度
}
```

**ターゲット発見条件**:
- 距離センサー ≤ 2cm **かつ** フォトセンサーが黒検知（ターゲット周囲の黒円検出）

#### B. セクション分割戦略（Sectioned Exploration）
フィールドを4つのセクションに分割し、各セクション内で効率的に探索

**分割案**:
- セクション1: 左上 (50-425mm × 50-425mm) - 3ターゲット
- セクション2: 右上 (425-1650mm × 50-425mm) - 3ターゲット  
- セクション3: 右下 (425-1650mm × 425-850mm) - 3ターゲット
- セクション4: 左下 (50-425mm × 425-850mm) - 3ターゲット

**実装方針**:
1. 各セクション内でのローカル最適化
2. セクション間移動の最小化
3. 境界線接近時の安全マージン確保

#### C. 渦巻き型最適化戦略（Optimized Spiral）
中央から外周へ向かう渦巻きパターンを、ターゲット位置に合わせて最適化

**実装方針**:
1. **ターゲット密度マップ**: 各領域のターゲット密度を事前計算
2. **適応的ステップサイズ**: ターゲット密度に応じてスパイラル半径を調整
3. **境界線予測回避**: 外周5cm手前で自動的に内側へ方向転換

### 9.3 センサー活用最適化

#### A. 距離センサーの効率的活用
- **予測スキャン**: ターゲット推定位置への優先的サーボ制御
- **セクター分割スキャン**: -90°～90°を6セクターに分割、優先度順にスキャン
- **スキャン結果キャッシュ**: 同一位置でのスキャン結果を一定時間保持

#### B. フォトセンサー予測制御
- **境界線接近予測**: 現在位置＋進行方向から境界線との交点を事前計算
- **安全マージン制御**: 境界線の3cm手前で進路変更を開始

### 9.4 パフォーマンス指標

**最適化目標**:
1. **探索時間最小化**: 全12ターゲット発見までの時間
2. **移動距離最小化**: 総移動距離の短縮
3. **安全性確保**: 衝突・落下ゼロの維持
4. **エネルギー効率**: 無駄な旋回・スキャン動作の削減

**期待性能**:
- 従来アルゴリズム: 平均180-300秒
- 最適化アルゴリズム: 平均60-120秒（50-60%改善目標）

---

## 10. 今後の拡張案（例）

- ロボットの自己位置推定（壁接触などによるリセット）
- ターゲット再訪の優先制御
- 並列探索（複数ロボット協調）
- ML強化学習によるセンサスキャン戦略最適化
- 動的環境対応（障害物・ターゲット位置変更）

---

